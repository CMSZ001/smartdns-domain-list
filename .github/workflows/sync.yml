name: Update SmartDNS CN Rules

on:
  schedule:
    - cron: '0 23 * * *'  # UTCæ—¶é—´23ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´7ç‚¹ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    - name: Setup Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Download and process CN rules
      run: |
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        temp_file=$(mktemp)

        # ä¸‹è½½è§„åˆ™æ–‡ä»¶
        curl -s "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/direct-list.txt" >> "$temp_file"
        curl -s "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/apple-cn.txt" >> "$temp_file"
        curl -s "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/google-cn.txt" >> "$temp_file"
        curl -s "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/china-list.txt" >> "$temp_file"

        # å¤„ç†è§„åˆ™ï¼šç§»é™¤full:å‰ç¼€ï¼Œåˆ é™¤regexpè¡Œå’Œç©ºè¡Œï¼Œè¿‡æ»¤æ‰alidns.comå’Œdoh.pub
        processed_temp=$(mktemp)
        sed "s/^full://g;/^regexp:.*$/d;/^$/d" "$temp_file" | grep -v "\.alidns\.com$" | grep -v "^doh\.pub$" > "$processed_temp"

        # å»é‡å¹¶æ·»åŠ nameserveræ ¼å¼
        sort -u "$processed_temp" | sed "s/^/nameserver \//g;s/$/\/CN/g" > cn.conf

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm "$temp_file" "$processed_temp"

    - name: Download and process reject rules
      run: |
        # ä¸‹è½½æ‹’ç»åˆ—è¡¨å¹¶è¿‡æ»¤æ‰umami.is
        curl -s "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/reject-list.txt" | grep -v "^umami.is$" > reject.conf

    - name: Force commit files
      run: |
        # æ·»åŠ æ‰€æœ‰é…ç½®æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add cn.conf reject.conf

        # åˆ›å»ºæ–°çš„æäº¤ï¼ŒåŒ…å«æ‰€æœ‰å˜åŒ–
        if [[ -z $(git status --porcelain) ]]; then
          echo "No changes to commit"
          exit 0
        fi

        # æäº¤æ–‡ä»¶
        git commit -m "Update CN and reject rules $(date +'%Y-%m-%d %H:%M:%S %Z')"

        # å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹ä»“åº“
        git push --force-with-lease origin HEAD:$(git branch --show-current)

    - name: ğŸ—‘ï¸ åˆ é™¤è¿è¡Œè®°å½• / Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      continue-on-error: true
      with:
        retain_days: '1'
        keep_minimum_runs: '0'